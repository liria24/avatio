<script setup lang="ts">
definePageMeta({
    middleware: 'admin',
    layout: 'dashboard',
})

const { data, status, refresh } = await useFetch('/api/changelogs', {
    dedupe: 'defer',
    default: () => ({
        data: [],
        pagination: {
            page: 1,
            limit: 0,
            total: 0,
            totalPages: 0,
            hasPrev: false,
            hasNext: false,
        },
    }),
    getCachedData: (key, nuxtApp, ctx) =>
        ctx.cause !== 'initial'
            ? undefined
            : nuxtApp.payload.data[key] || nuxtApp.static.data[key],
})
</script>

<template>
    <UDashboardPanel id="changelogs">
        <template #header>
            <UDashboardNavbar title="Changelogs">
                <template #right>
                    <UButton
                        to="/admin/changelogs/compose"
                        icon="lucide:plus"
                        label="New Changelog"
                        color="neutral"
                    />

                    <UButton
                        :loading="status === 'pending'"
                        icon="lucide:refresh-cw"
                        variant="soft"
                        color="neutral"
                        @click="refresh()"
                    />
                </template>
            </UDashboardNavbar>
        </template>

        <template #body>
            <div class="flex flex-col gap-4">
                <UCard v-for="changelog in data.data" :key="changelog.slug">
                    <template #header>
                        <div class="flex items-center justify-between gap-3">
                            <span class="font-medium">
                                {{ changelog.title }}
                            </span>

                            <NuxtTime
                                :datetime="changelog.createdAt"
                                relative
                                class="text-muted text-sm"
                            />
                        </div>
                    </template>

                    <UCollapsible class="flex flex-col gap-2">
                        <UButton
                            label="Markdown"
                            color="neutral"
                            variant="soft"
                            trailing-icon="i-lucide-chevron-down"
                            block
                        />

                        <template #content>
                            <MDC
                                :value="changelog.markdown"
                                class="w-full max-w-full"
                            />
                        </template>
                    </UCollapsible>
                </UCard>
            </div>
        </template>
    </UDashboardPanel>
</template>
