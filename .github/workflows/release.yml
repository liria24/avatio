name: Release on Version PR Merge

on:
    pull_request:
        branches:
            - main
        types: [closed]

jobs:
    release:
        if: |
            github.event.pull_request.merged == true &&
            startsWith(github.event.pull_request.title, 'v')
        runs-on: ubuntu-slim
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 24

            - name: Generate Changelog
              id: changelog
              run: |
                  echo "CHANGELOG_BODY<<EOF" >> $GITHUB_ENV
                  npx changelogen@latest --hideAuthorEmail --output >> $GITHUB_ENV
                  echo "EOF" >> $GITHUB_ENV

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  name: ${{ github.event.pull_request.title }}
                  tag_name: ${{ github.event.pull_request.title }}
                  body: ${{ env.CHANGELOG_BODY }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
