name: Release on Version PR Merge

on:
    pull_request:
        branches:
            - main
        types: [closed]
    workflow_dispatch:
        inputs:
            tag_name:
                description: 'Release tag (e.g. v1.0.0)'
                required: true
                default: 'v0.0.0'

jobs:
    release:
        if: |
            (github.event.pull_request.merged == true && startsWith(github.event.pull_request.title, 'v')) ||
            github.event_name == 'workflow_dispatch'
        runs-on: ubuntu-slim
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 24
                  cache: 'npm'

            - name: Generate Changelog
              id: changelog
              run: |
                  echo "CHANGELOG_BODY<<EOF" >> $GITHUB_ENV
                  npx changelogen@latest --hideAuthorEmail --output >> $GITHUB_ENV
                  echo "EOF" >> $GITHUB_ENV

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ github.event.pull_request.title || github.event.inputs.tag_name }}
                  name: ${{ github.event.pull_request.title || github.event.inputs.tag_name }}
                  body: ${{ env.CHANGELOG_BODY }}
                  generate_release_notes: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
